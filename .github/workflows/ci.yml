name: CI - Build and Test Extensions

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  merge_group:

jobs:
  detect-changes:
    name: Detect Changed Projects
    runs-on: ubuntu-latest
    outputs:
      projects: ${{ steps.changes.outputs.projects }}
      all-projects: ${{ steps.set-all.outputs.projects }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        id: changes
        run: |
          # Define all active projects (excluding bluetooth which is empty)
          ALL_PROJECTS='["bitwarden", "home-assistant-actions", "port-killer", "tailscale", "weather"]'
          
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            # On main branch push, always run all projects
            echo "projects=$ALL_PROJECTS" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            # On PR, detect which project directories have changes
            CHANGED_PROJECTS='[]'
            
            # Get list of changed files
            if [ "${{ github.event.pull_request.base.sha }}" != "" ]; then
              CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..HEAD)
            else
              CHANGED_FILES=$(git diff --name-only HEAD~1..HEAD)
            fi
            
            echo "Changed files:"
            echo "$CHANGED_FILES"
            
            # Check each project for changes
            for project in bitwarden home-assistant-actions port-killer tailscale weather; do
              if echo "$CHANGED_FILES" | grep -q "^$project/"; then
                echo "Changes detected in $project"
                if [ "$CHANGED_PROJECTS" = "[]" ]; then
                  CHANGED_PROJECTS="[\"$project\"]"
                else
                  CHANGED_PROJECTS=$(echo "$CHANGED_PROJECTS" | sed "s/]$/, \"$project\"]/")
                fi
              fi
            done
            
            # If no specific projects changed, but there are changes to root files, run all
            if [ "$CHANGED_PROJECTS" = "[]" ] && [ -n "$CHANGED_FILES" ]; then
              echo "Root level changes detected, running all projects"
              CHANGED_PROJECTS="$ALL_PROJECTS"
            fi
            
            echo "projects=$CHANGED_PROJECTS" >> $GITHUB_OUTPUT
          else
            # For other events, run all projects
            echo "projects=$ALL_PROJECTS" >> $GITHUB_OUTPUT
          fi

      - name: Set all projects output
        id: set-all
        run: |
          echo 'projects=["bitwarden", "home-assistant-actions", "port-killer", "tailscale", "weather"]' >> $GITHUB_OUTPUT

  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.projects != '[]'
    strategy:
      fail-fast: false
      matrix:
        project: ${{ fromJson(needs.detect-changes.outputs.projects) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if project has package.json
        id: check-package
        run: |
          if [ -f "${{ matrix.project }}/package.json" ]; then
            echo "has-package=true" >> $GITHUB_OUTPUT
          else
            echo "has-package=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No package.json found in ${{ matrix.project }}"
          fi

      - name: Setup Node.js
        if: steps.check-package.outputs.has-package == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: '${{ matrix.project }}/package-lock.json'

      - name: Install dependencies
        if: steps.check-package.outputs.has-package == 'true'
        working-directory: ${{ matrix.project }}
        run: |
          echo "ðŸ“¦ Installing dependencies for ${{ matrix.project }}"
          npm ci

      - name: Generate/update package-lock.json
        if: steps.check-package.outputs.has-package == 'true'
        working-directory: ${{ matrix.project }}
        run: |
          echo "ðŸ”’ Generating/updating package-lock.json for ${{ matrix.project }}"
          # Remove existing package-lock.json if it exists
          rm -f package-lock.json
          # Generate fresh package-lock.json
          npm install --package-lock-only
          
          # Check if package-lock.json was created/updated
          if [ -f package-lock.json ]; then
            echo "âœ… package-lock.json generated successfully"
            echo "ðŸ“Š Package lock file stats:"
            wc -l package-lock.json
            ls -lh package-lock.json
          else
            echo "âŒ Failed to generate package-lock.json"
            exit 1
          fi

      - name: Verify dependencies
        if: steps.check-package.outputs.has-package == 'true'
        working-directory: ${{ matrix.project }}
        run: |
          echo "ðŸ” Verifying dependency integrity for ${{ matrix.project }}"
          npm audit --audit-level moderate

      - name: Run linting
        if: steps.check-package.outputs.has-package == 'true'
        working-directory: ${{ matrix.project }}
        run: |
          echo "ðŸ§¹ Running linting for ${{ matrix.project }}"
          # Check if lint script exists
          if npm run lint --if-present 2>/dev/null; then
            echo "âœ… Linting passed"
          else
            echo "âš ï¸ No lint script found or lint script failed"
          fi

      - name: Run formatting check
        if: steps.check-package.outputs.has-package == 'true'
        working-directory: ${{ matrix.project }}
        run: |
          echo "ðŸ’… Checking code formatting for ${{ matrix.project }}"
          # Check if format script exists (like in port-killer)
          if npm run format --if-present 2>/dev/null; then
            echo "âœ… Formatting check passed"
          else
            echo "âš ï¸ No format script found"
          fi

      - name: Build project
        if: steps.check-package.outputs.has-package == 'true'
        working-directory: ${{ matrix.project }}
        run: |
          echo "ðŸ—ï¸ Building ${{ matrix.project }}"
          npm run build

      - name: Check build output
        if: steps.check-package.outputs.has-package == 'true'
        working-directory: ${{ matrix.project }}
        run: |
          echo "ðŸ“‹ Build output verification for ${{ matrix.project }}"
          # Look for common build output directories/files
          if [ -d "dist" ]; then
            echo "âœ… Found dist/ directory"
            ls -la dist/
          elif [ -d "build" ]; then
            echo "âœ… Found build/ directory"
            ls -la build/
          elif [ -d "lib" ]; then
            echo "âœ… Found lib/ directory"
            ls -la lib/
          else
            echo "âš ï¸ No standard build output directory found"
            echo "Current directory contents:"
            ls -la
          fi

      - name: Upload build artifacts
        if: steps.check-package.outputs.has-package == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.project }}-build
          path: |
            ${{ matrix.project }}/dist/
            ${{ matrix.project }}/build/
            ${{ matrix.project }}/lib/
            ${{ matrix.project }}/package-lock.json
          retention-days: 7

  # Job to commit updated package-lock.json files back to the repository
  update-lockfiles:
    name: Update Package Lock Files
    runs-on: ubuntu-latest
    needs: [detect-changes, build-and-test]
    if: |
      needs.detect-changes.outputs.projects != '[]' && 
      github.event_name == 'push' && 
      github.ref == 'refs/heads/main'
    strategy:
      matrix:
        project: ${{ fromJson(needs.detect-changes.outputs.all-projects) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Check if project has package.json
        id: check-package
        run: |
          if [ -f "${{ matrix.project }}/package.json" ]; then
            echo "has-package=true" >> $GITHUB_OUTPUT
          else
            echo "has-package=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate package-lock.json
        if: steps.check-package.outputs.has-package == 'true'
        working-directory: ${{ matrix.project }}
        run: |
          # Generate/update package-lock.json
          npm install --package-lock-only

      - name: Check for changes
        if: steps.check-package.outputs.has-package == 'true'
        id: check-changes
        working-directory: ${{ matrix.project }}
        run: |
          if git diff --exit-code package-lock.json; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "No changes to package-lock.json in ${{ matrix.project }}"
          else
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in package-lock.json for ${{ matrix.project }}"
          fi

      - name: Commit package-lock.json
        if: steps.check-package.outputs.has-package == 'true' && steps.check-changes.outputs.has-changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add "${{ matrix.project }}/package-lock.json"
          git commit -m "chore(${{ matrix.project }}): update package-lock.json [skip ci]"
          git push

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, build-and-test]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ—ï¸ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.detect-changes.outputs.projects }}" = "[]" ]; then
            echo "âœ… No projects needed building (no changes detected)" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ“¦ **Projects processed:** ${{ needs.detect-changes.outputs.projects }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ needs.build-and-test.result }}" = "success" ]; then
              echo "âœ… **All builds successful**" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.build-and-test.result }}" = "failure" ]; then
              echo "âŒ **Some builds failed**" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.build-and-test.result }}" = "cancelled" ]; then
              echo "â¹ï¸ **Builds were cancelled**" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ **Builds status: ${{ needs.build-and-test.result }}**" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Workflow completed at $(date)_" >> $GITHUB_STEP_SUMMARY